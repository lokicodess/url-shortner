apiVersion: apps/v1
kind: Deployment
metadata:
  name: url-shortener-api
  labels:
    app: url-shortener-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: url-shortener-api
  template:
    metadata:
      labels:
        app: url-shortener-api
    spec:
      containers:
        - name: api
          image: lokesh3721/url-shortner-api:21
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          command: ["./app"]
          args:
            - "--port=$(APP_PORT)"
            - "--env=$(APP_ENV)"
            - "--db-dsn=$(DB_USER):$(DB_PASS)@tcp($(DB_HOST):$(DB_PORT))/$(DB_NAME)?parseTime=true"
            - "--db-max-open-conns=$(DB_MAX_OPEN_CONNS)"
            - "--db-max-idle-conns=$(DB_MAX_IDLE_CONNS)"
            - "--db-max-idle-time=$(DB_MAX_IDLE_TIME)"
            - "--db-max-life-time=$(DB_MAX_LIFE_TIME)"
            - "--limiter-rps=$(LIMITER_RPS)"
            - "--limiter-burst=$(LIMITER_BURST)"
            - "--limiter-enabled=$(LIMITER_ENABLED)"
          env:
            # RDS Configuration (from Secret)
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: rds-secret
                  key: HOST
            - name: DB_PORT
              valueFrom:
                secretKeyRef:
                  name: rds-secret
                  key: PORT
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: rds-secret
                  key: USERNAME
            - name: DB_PASS
              valueFrom:
                secretKeyRef:
                  name: rds-secret
                  key: PASSWORD
            - name: DB_NAME
              valueFrom:
                secretKeyRef:
                  name: rds-secret
                  key: DATABASE

            # Application Configuration (from ConfigMap)
            - name: APP_PORT
              valueFrom:
                configMapKeyRef:
                  name: api-config
                  key: APP_PORT
            - name: APP_ENV
              valueFrom:
                configMapKeyRef:
                  name: api-config
                  key: APP_ENV
            - name: DB_MAX_OPEN_CONNS
              valueFrom:
                configMapKeyRef:
                  name: api-config
                  key: DB_MAX_OPEN_CONNS
            - name: DB_MAX_IDLE_CONNS
              valueFrom:
                configMapKeyRef:
                  name: api-config
                  key: DB_MAX_IDLE_CONNS
            - name: DB_MAX_IDLE_TIME
              valueFrom:
                configMapKeyRef:
                  name: api-config
                  key: DB_MAX_IDLE_TIME
            - name: DB_MAX_LIFE_TIME
              valueFrom:
                configMapKeyRef:
                  name: api-config
                  key: DB_MAX_LIFE_TIME
            - name: LIMITER_RPS
              valueFrom:
                configMapKeyRef:
                  name: api-config
                  key: LIMITER_RPS
            - name: LIMITER_BURST
              valueFrom:
                configMapKeyRef:
                  name: api-config
                  key: LIMITER_BURST
            - name: LIMITER_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: api-config
                  key: LIMITER_ENABLED
          # Health checks
          livenessProbe:
            httpGet:
              path: /healthcheck
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthcheck
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "500m"
